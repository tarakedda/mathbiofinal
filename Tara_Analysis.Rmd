
---
title: "Tara's HD Analysis"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---
install.packages("tidyverse")
library(tidyverse)   # lets me get the data
install.packages("dplyr")
library(dplyr)       # lets me edit the data
install.packages("ggcorrplot")
library(ggcorrplot)  # for the heatmaps
install.packages("caret")
library(caret)       # in case of missing data
install.packages("FactoMineR")
library(FactoMineR)  # PCA
install.packages("factoextra")
library(factoextra)  # PCA
install.packages("MASS")
library(MASS) #regression
install.packages("cli")
library(cli)
load("/Users/kedda/Downloads/bios26211projectfinal/NHANES3_HDTrain.rda")
load("/Users/kedda/Downloads/bios26211projectfinal/NHANES3.rda")
load("/Users/kedda/Downloads/bios26211projectfinal/NHANES4.rda")

#load bioage
install.packages("devtools")
devtools::install_github("dayoonkwon/BioAge")
library(BioAge)

# checking if there's missing vals
colSums(is.na(NHANES4))
#there ended up being a ton, so now I am going to compute the percent that is missing from each so I can choose only those that have enough data.
missing_perc <- colSums(is.na(NHANES4)) / nrow(NHANES4)
print(percent_missing)
#looking at data visually, I decided that those with over 10% missing should be excluded from the biomarkers chosen
NHANES4_filtered <- NHANES4[, missing_perc < 0.1]
str(NHANES4_filtered)

NHANES3_filtered <- NHANES3[, missing_perc < 0.1]
str(NHANES3_filtered)
#from these lists, I picked out all data that was listed as a "biomarker" in the dataset and then also age (chronological age) since it would be valuable to have that in the dataset later when we compare the determined biological age to chronological age

#below are the biomarkers i chose. i had to exclude "neut" since even though it showed up as being <10% for NHANES3, it also only had NA in it so I got rid of it. see attached README for what each of these variables mean.
biomarkers_with_age <- c("age","lymph", "mcv", "rbc", "rdw", "wbc", "dbp","sbp", "meanbp", "pulse", "phpfast")



# impute NHANES4 and NHANES3 with means (basically replaces all the NA vals with mean for that so the program doesn't get confused during analysis)
NHANES4_imputed <- NHANES4
for (col in biomarkers_with_age) {
  if (col %in% colnames(NHANES4_imputed)) {  # Ensure column exists
    NHANES4_imputed[[col]][is.na(NHANES4_imputed[[col]])] <- mean(NHANES4_imputed[[col]], na.rm = TRUE)
  }
}
NHANES3_imputed <- NHANES3
for (col in biomarkers_with_age) {
  if (col %in% colnames(NHANES3_imputed)) {  # Ensure column exists
    NHANES3_imputed[[col]][is.na(NHANES3_imputed[[col]])] <- mean(NHANES3_imputed[[col]], na.rm = TRUE)
  }
}


hd_result <- hd_calc(NHANES4_imputed, NHANES3_imputed, biomarkers_with_age)

#this is the data with JUST the biomarkers I want
hd_data_filtered <- hd_data[, biomarkers_with_age]
head(hd_data_filtered)



biomarkers <- c("lymph", "mcv", "rbc", "rdw", "wbc", "dbp","sbp", "meanbp", "pulse", "phpfast")

NHANES4_imfil <- NHANES4_imputed
NHANES4_imfil <- NHANES4_imfil[, biomarkers]
head(NHANES4_imfil)

NHANES3_imfil <- NHANES3_imputed
NHANES3_imfil <- NHANES3_imfil[, biomarkers]
head(NHANES3_imfil)

#scaling data so can use it for PCA and matrix analysis BUT since NHANES4 is trained on NHANES3 and also I just want to standardize it, I'm using the means/SDs from NHANES3 to scale it
NHANES3_stats <- list()

for (col in biomarkers_with_age) {
  NHANES3_stats[[col]] <- list(
    mean = mean(NHANES3_imputed[[col]], na.rm = TRUE),
    sd = sd(NHANES3_imputed[[col]], na.rm = TRUE)
  )
}

NHANES3_scaled <- NHANES3_imfil
NHANES4_scaled <- NHANES4_imfil

for (col in biomarkers) {
  NHANES3_scaled[[col]] <- (NHANES3_scaled[[col]] - NHANES3_stats[[col]]$mean) / NHANES3_stats[[col]]$sd
  NHANES4_scaled[[col]] <- (NHANES4_scaled[[col]] - NHANES3_stats[[col]]$mean) / NHANES3_stats[[col]]$sd
}
head(NHANES4_scaled)

#now that it's scaled, making a correlation matrix so i can see which are most correlated, used claude and https://cran.r-project.org/web/packages/ggcorrplot/readme/README.html to help with formatting
cor_matrix <- cor(NHANES4_scaled[, biomarkers])
ggcorrplot(cor_matrix, method = "square", type = "lower", lab = TRUE, outline.color = "black", colors = c("#009e73", "white", "#cc79a7"), title = "Correlation Matrix for Biomarkers With <10% Missing Data")

#new!